<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Query Builder 查询 | 个人博客</title>
    <meta name="description" content="This is a blog example built by VuePress">
    
    
    <link rel="preload" href="/vuepressblog/assets/css/0.styles.782d1301.css" as="style"><link rel="preload" href="/vuepressblog/assets/js/app.34ed5399.js" as="script"><link rel="preload" href="/vuepressblog/assets/js/4.b4e60a56.js" as="script"><link rel="preload" href="/vuepressblog/assets/js/5.437ceeb3.js" as="script"><link rel="preload" href="/vuepressblog/assets/js/56.52bdbaf9.js" as="script"><link rel="prefetch" href="/vuepressblog/assets/js/1.16f713a9.js"><link rel="prefetch" href="/vuepressblog/assets/js/10.940970eb.js"><link rel="prefetch" href="/vuepressblog/assets/js/11.b539ea55.js"><link rel="prefetch" href="/vuepressblog/assets/js/12.0cfe72b3.js"><link rel="prefetch" href="/vuepressblog/assets/js/13.e03e06a0.js"><link rel="prefetch" href="/vuepressblog/assets/js/14.d51b12fd.js"><link rel="prefetch" href="/vuepressblog/assets/js/15.2f6bd966.js"><link rel="prefetch" href="/vuepressblog/assets/js/16.c821a87b.js"><link rel="prefetch" href="/vuepressblog/assets/js/17.1d39a121.js"><link rel="prefetch" href="/vuepressblog/assets/js/18.b7328a1a.js"><link rel="prefetch" href="/vuepressblog/assets/js/19.def8f7d1.js"><link rel="prefetch" href="/vuepressblog/assets/js/20.af7b2e69.js"><link rel="prefetch" href="/vuepressblog/assets/js/21.baeb5c5c.js"><link rel="prefetch" href="/vuepressblog/assets/js/22.e3ea399c.js"><link rel="prefetch" href="/vuepressblog/assets/js/23.eb03037a.js"><link rel="prefetch" href="/vuepressblog/assets/js/24.b2b8255c.js"><link rel="prefetch" href="/vuepressblog/assets/js/25.d648b024.js"><link rel="prefetch" href="/vuepressblog/assets/js/26.0e3152ba.js"><link rel="prefetch" href="/vuepressblog/assets/js/27.deaabd4e.js"><link rel="prefetch" href="/vuepressblog/assets/js/28.ed1f0893.js"><link rel="prefetch" href="/vuepressblog/assets/js/29.4669c16f.js"><link rel="prefetch" href="/vuepressblog/assets/js/30.8b26e6d0.js"><link rel="prefetch" href="/vuepressblog/assets/js/31.116a34db.js"><link rel="prefetch" href="/vuepressblog/assets/js/32.93e9dbf1.js"><link rel="prefetch" href="/vuepressblog/assets/js/33.14d71321.js"><link rel="prefetch" href="/vuepressblog/assets/js/34.d895ea94.js"><link rel="prefetch" href="/vuepressblog/assets/js/35.b73195c8.js"><link rel="prefetch" href="/vuepressblog/assets/js/36.d6a475e0.js"><link rel="prefetch" href="/vuepressblog/assets/js/37.1d249a16.js"><link rel="prefetch" href="/vuepressblog/assets/js/38.5bfebe3a.js"><link rel="prefetch" href="/vuepressblog/assets/js/39.98d3abdc.js"><link rel="prefetch" href="/vuepressblog/assets/js/40.77362dd9.js"><link rel="prefetch" href="/vuepressblog/assets/js/41.9714a402.js"><link rel="prefetch" href="/vuepressblog/assets/js/42.5c80b8f2.js"><link rel="prefetch" href="/vuepressblog/assets/js/43.8d567d37.js"><link rel="prefetch" href="/vuepressblog/assets/js/44.d6b5729c.js"><link rel="prefetch" href="/vuepressblog/assets/js/45.d36f522e.js"><link rel="prefetch" href="/vuepressblog/assets/js/46.753217d8.js"><link rel="prefetch" href="/vuepressblog/assets/js/47.5e317be5.js"><link rel="prefetch" href="/vuepressblog/assets/js/48.633080c8.js"><link rel="prefetch" href="/vuepressblog/assets/js/49.59540068.js"><link rel="prefetch" href="/vuepressblog/assets/js/50.c6bac4b3.js"><link rel="prefetch" href="/vuepressblog/assets/js/51.5e9507f2.js"><link rel="prefetch" href="/vuepressblog/assets/js/52.f1b4f07f.js"><link rel="prefetch" href="/vuepressblog/assets/js/53.79627a04.js"><link rel="prefetch" href="/vuepressblog/assets/js/54.7321bb5a.js"><link rel="prefetch" href="/vuepressblog/assets/js/55.81f96300.js"><link rel="prefetch" href="/vuepressblog/assets/js/57.46b90993.js"><link rel="prefetch" href="/vuepressblog/assets/js/58.bc612a04.js"><link rel="prefetch" href="/vuepressblog/assets/js/59.849c15d9.js"><link rel="prefetch" href="/vuepressblog/assets/js/6.2eb981f1.js"><link rel="prefetch" href="/vuepressblog/assets/js/60.3e5b9b12.js"><link rel="prefetch" href="/vuepressblog/assets/js/61.0d44f6fc.js"><link rel="prefetch" href="/vuepressblog/assets/js/62.04363bf9.js"><link rel="prefetch" href="/vuepressblog/assets/js/63.cca8ee33.js"><link rel="prefetch" href="/vuepressblog/assets/js/64.96e45510.js"><link rel="prefetch" href="/vuepressblog/assets/js/65.63ac4374.js"><link rel="prefetch" href="/vuepressblog/assets/js/66.7ec49135.js"><link rel="prefetch" href="/vuepressblog/assets/js/67.0a87e1f1.js"><link rel="prefetch" href="/vuepressblog/assets/js/68.2c53fc3a.js"><link rel="prefetch" href="/vuepressblog/assets/js/69.ec436606.js"><link rel="prefetch" href="/vuepressblog/assets/js/7.5286a1d0.js"><link rel="prefetch" href="/vuepressblog/assets/js/70.32df5cd4.js"><link rel="prefetch" href="/vuepressblog/assets/js/71.2329802d.js"><link rel="prefetch" href="/vuepressblog/assets/js/72.80b3ff8f.js"><link rel="prefetch" href="/vuepressblog/assets/js/8.fec3f887.js"><link rel="prefetch" href="/vuepressblog/assets/js/9.addd09b9.js"><link rel="prefetch" href="/vuepressblog/assets/js/vuejs-paginate.47274855.js">
    <link rel="stylesheet" href="/vuepressblog/assets/css/0.styles.782d1301.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuperess-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/vuepressblog/" class="nav-link home-link">个人博客
        </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/vuepressblog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/vuepressblog/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/vuepressblog/" class="nav-link mobile-home-link">个人博客
      </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/vuepressblog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/vuepressblog/tag/" class="nav-link">Tags</a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuperess-theme-blog__post-layout"><div class="vuepress-blog-theme-content"><div class="content__default"><h1 id="使用-query-builder-查询"><a href="#使用-query-builder-查询" class="header-anchor">#</a> 使用 Query Builder 查询</h1> <ul><li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%60QueryBuilder%60">什么是<code>QueryBuilder</code></a></li> <li><a href="#%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%60QueryBuilder%60">如何创建和使用<code>QueryBuilder</code></a></li> <li><a href="#%E4%BD%BF%E7%94%A8%60QueryBuilder%60%E8%8E%B7%E5%8F%96%E5%80%BC">使用<code>QueryBuilder</code>获取值</a></li> <li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%AB%E5%90%8D%EF%BC%9F">什么是别名？</a></li> <li><a href="#%E4%BD%BF%E7%94%A8%E5%8F%82%E6%95%B0%E6%9D%A5%E8%BD%AC%E4%B9%89%E6%95%B0%E6%8D%AE">使用参数来转义数据</a></li> <li><a href="#%E6%B7%BB%E5%8A%A0%60WHERE%60%E8%A1%A8%E8%BE%BE%E5%BC%8F">添加<code>WHERE</code>表达式</a></li> <li><a href="#%E6%B7%BB%E5%8A%A0%60HAVING%60%E8%A1%A8%E8%BE%BE%E5%BC%8F">添加<code>HAVING</code>表达式</a></li> <li><a href="#%E6%B7%BB%E5%8A%A0%60ORDER-BY%60%E8%A1%A8%E8%BE%BE%E5%BC%8F">添加<code>ORDER BY</code>表达式</a></li> <li><a href="#%E6%B7%BB%E5%8A%A0%60GROUP-BY%60%E8%A1%A8%E8%BE%BE%E5%BC%8F">添加<code>GROUP BY</code>表达式</a></li> <li><a href="#%E6%B7%BB%E5%8A%A0%60LIMIT%60%E8%A1%A8%E8%BE%BE%E5%BC%8F">添加<code>LIMIT</code>表达式</a></li> <li><a href="#%E6%B7%BB%E5%8A%A0%60OFFSET%60%E8%A1%A8%E8%BE%BE%E5%BC%8F">添加<code>OFFSET</code>表达式</a></li> <li><a href="#%E8%81%94%E6%9F%A5">联查</a></li> <li><a href="#%E5%86%85%E8%81%94%E5%92%8C%E5%B7%A6%E8%81%94">内联和左联</a></li> <li><a href="#%E4%B8%8D%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E7%9A%84%E8%81%94%E6%9F%A5">不使用条件的联查</a></li> <li><a href="#%E8%81%94%E6%9F%A5%E4%BB%BB%E4%BD%95%E5%AE%9E%E4%BD%93%E6%88%96%E8%A1%A8">联查任何实体或表</a></li> <li><a href="#%E8%81%94%E6%9F%A5%E5%92%8C%E6%98%A0%E5%B0%84%E5%8A%9F%E8%83%BD">联查和映射功能</a></li> <li><a href="#%E8%8E%B7%E5%8F%96%E7%94%9F%E6%88%90%E7%9A%84sql%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5">获取生成的sql查询语句</a></li> <li><a href="#%E8%8E%B7%E5%BE%97%E5%8E%9F%E5%A7%8B%E7%BB%93%E6%9E%9C">获得原始结果</a></li> <li><a href="#%E6%B5%81%E6%95%B0%E6%8D%AE">流数据</a></li> <li><a href="#%E5%88%86%E9%A1%B5">分页</a></li> <li><a href="#%E5%8A%A0%E9%94%81">加锁</a></li> <li><a href="#%E6%9F%A5%E8%AF%A2%E9%83%A8%E5%88%86%E5%AD%97%E6%AE%B5">查询部分字段</a></li> <li><a href="#%E4%BD%BF%E7%94%A8%E5%AD%90%E6%9F%A5%E8%AF%A2">使用子查询</a></li> <li><a href="#%E9%9A%90%E8%97%8F%E5%88%97">隐藏列</a></li></ul> <h2 id="什么是querybuilder"><a href="#什么是querybuilder" class="header-anchor">#</a> 什么是<code>QueryBuilder</code></h2> <p><code>QueryBuilder</code>是 TypeORM 最强大的功能之一 ，它允许你使用优雅便捷的语法构建 SQL 查询，执行并获得自动转换的实体。</p> <p><code>QueryBuilder</code>的简单示例:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> firstUser <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>它将生成以下 SQL 查询：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
    <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token keyword">as</span> userId<span class="token punctuation">,</span>
    <span class="token keyword">user</span><span class="token punctuation">.</span>firstName <span class="token keyword">as</span> userFirstName<span class="token punctuation">,</span>
    <span class="token keyword">user</span><span class="token punctuation">.</span>lastName <span class="token keyword">as</span> userLastName
<span class="token keyword">FROM</span> users <span class="token keyword">user</span>
<span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><p>然后返回一个 <code>User</code> 实例:</p> <div class="language- extra-class"><pre class="language-text"><code>User {
    id: 1,
    firstName: &quot;Timber&quot;,
    lastName: &quot;Saw&quot;
}
</code></pre></div><h2 id="如何创建和使用querybuilder"><a href="#如何创建和使用querybuilder" class="header-anchor">#</a> 如何创建和使用<code>QueryBuilder</code></h2> <p>有几种方法可以创建<code>Query Builder</code>：</p> <ul><li><p>使用 connection:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getConnection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>使用 entity manager:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getManager <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>使用 repository:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <p>有 5 种不同的<code>QueryBuilder</code>类型可用：</p> <ul><li><p><code>SelectQueryBuilder</code> - 用于构建和执行<code>SELECT</code>查询。 例如：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getConnection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><code>InsertQueryBuilder</code> - 用于构建和执行<code>INSERT</code>查询。 例如：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getConnection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Saw&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Phantom&quot;</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Lancer&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><code>UpdateQueryBuilder</code> - 用于构建和执行<code>UPDATE</code>查询。 例如：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getConnection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Saw&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><code>DeleteQueryBuilder</code> - 用于构建和执行<code>DELETE</code>查询。 例如：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getConnection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><code>RelationQueryBuilder</code> - 用于构建和执行特定于关系的操作[TBD]。</p></li></ul> <p>你可以在其中切换任何不同类型的查询构建器，一旦执行，则将获得一个新的查询构建器实例（与所有其他方法不同）。</p> <h2 id="使用querybuilder获取值"><a href="#使用querybuilder获取值" class="header-anchor">#</a> 使用<code>QueryBuilder</code>获取值</h2> <p>要从数据库中获取单个结果，例如通过 id 或 name 获取用户，必须使用<code>getOne</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> timber <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id OR user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要从数据库中获取多个结果，例如，要从数据库中获取所有用户，请使用<code>getMany</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用查询构建器查询可以获得两种类型的结果：<strong>entities</strong> 或 <strong>raw results</strong>。
大多数情况下，你只需要从数据库中选择真实实体，例如 users。
为此，你可以使用<code>getOne</code>和<code>getMany</code>。
但有时你需要选择一些特定的数据，比方说所有<em>sum of all user photos</em>。
此数据不是实体，它称为原始数据。
要获取原始数据，请使用<code>getRawOne</code>和<code>getRawMany</code>。
例如：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;SUM(user.photosCount)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getRawOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> photosSums <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">addSelect</span><span class="token punctuation">(</span><span class="token string">&quot;SUM(user.photosCount)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getRawMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 结果会像这样: [{ id: 1, sum: 25 }, { id: 2, sum: 13 }, ...]</span>
</code></pre></div><h2 id="什么是别名？"><a href="#什么是别名？" class="header-anchor">#</a> 什么是别名？</h2> <p>我们使用<code>createQueryBuilder（&quot;user&quot;）</code>。 但什么是&quot;user&quot;？
它只是一个常规的 SQL 别名。
我们在任何地方都使用别名，除非我们处理选定的数据。</p> <p><code>createQueryBuilder(&quot;user&quot;)</code> 相当于：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这会生成以下 sql 查询：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span>
</code></pre></div><p>在这个 SQL 查询中，<code>users</code>是表名，<code>user</code>是我们分配给该表的别名。</p> <p>稍后我们使用此别名来访问表：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上代码会生成如下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Timber'</span>
</code></pre></div><p>看到了吧，我们使用了在创建查询构建器时分配的<code>user</code>别名来使用 users 表。</p> <p>一个查询构建器不限于一个别名，它们可以有多个别名。
每个选择都可以有自己的别名，你可以选择多个有自己别名的表，你可以使用自己的别名连接多个表。
你也可以使用这些别名来访问选择的表（或正在选择的数据）。</p> <h2 id="使用参数来转义数据"><a href="#使用参数来转义数据" class="header-anchor">#</a> 使用参数来转义数据</h2> <p>我们使用了<code>where(&quot;user.name = :name&quot;, { name: &quot;Timber&quot; })</code>.
<code>{name：“Timber”}</code>代表什么？ 这是我们用来阻止 SQL 注入的参数。
我们可以写：<code>where（&quot;user.name ='&quot;+ name +&quot;'）</code>，但是这不安全，因为有可能被 SQL 注入。
安全的方法是使用这种特殊的语法：<code>where（&quot;user.name =name&quot;，{name:&quot;Timber&quot;}）</code>，其中<code>name</code>是参数名，值在对象中指定： <code>{name:&quot;Timber&quot;}</code>。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>是下面的简写：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Timber&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>注意：不要在查询构建器中为不同的值使用相同的参数名称。如果多次设置则后值将会把前面的覆盖。</p> <p>还可以提供一组值，并使用特殊的扩展语法将它们转换为SQL语句中的值列表：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name IN (:...names)&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> names<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;Timber&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Cristal&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Lina&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>该语句将生成：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'Timber'</span><span class="token punctuation">,</span> <span class="token string">'Cristal'</span><span class="token punctuation">,</span> <span class="token string">'Lina'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="添加where表达式"><a href="#添加where表达式" class="header-anchor">#</a> 添加<code>WHERE</code>表达式</h2> <p>添加 <code>WHERE</code> 表达式就像：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Timber'</span>
</code></pre></div><p>你可以将 <code>AND</code> 添加到现有的 <code>WHERE</code> 表达式中：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.firstName = :firstName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">&quot;user.lastName = :lastName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Saw&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span> <span class="token operator">AND</span> <span class="token keyword">user</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span>
</code></pre></div><p>你也可以添加 <code>OR</code> 添加到现有的 <code>WHERE</code> 表达式中：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.firstName = :firstName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string">&quot;user.lastName = :lastName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Saw&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span> <span class="token operator">OR</span> <span class="token keyword">user</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span>
</code></pre></div><p>你可以使用<code>Brackets</code>将复杂的<code>WHERE</code>表达式添加到现有的<code>WHERE</code>中：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.registered = :registered&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> registered<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Brackets</span><span class="token punctuation">(</span><span class="token parameter">qb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.firstName = :firstName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string">&quot;user.lastName = :lastName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Saw&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>registered <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span> <span class="token operator">OR</span> <span class="token keyword">user</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span><span class="token punctuation">)</span>
</code></pre></div><p>你可以根据需要组合尽可能多的<code>AND</code>和<code>OR</code>表达式。
如果你多次使用<code>.where</code>，你将覆盖所有以前的<code>WHERE</code>表达式。
注意：小心<code>orWhere</code> - 如果你使用带有<code>AND</code>和<code>OR</code>表达式的复杂表达式，请记住他们将无限制的叠加。
有时你只需要创建一个 where 字符串，避免使用<code>orWhere</code>。</p> <h2 id="添加having表达式"><a href="#添加having表达式" class="header-anchor">#</a> 添加<code>HAVING</code>表达式</h2> <p>添加<code>HAVING</code>表达式很简单：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">HAVING</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Timber'</span>
</code></pre></div><p>你可以添加 <code>AND</code> 到已经存在的 <code>HAVING</code> 表达式中：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span><span class="token string">&quot;user.firstName = :firstName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">andHaving</span><span class="token punctuation">(</span><span class="token string">&quot;user.lastName = :lastName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Saw&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">HAVING</span> <span class="token keyword">user</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span> <span class="token operator">AND</span> <span class="token keyword">user</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span>
</code></pre></div><p>你可以添加 <code>OR</code> 到已经存在的 <code>HAVING</code> 表达式中：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span><span class="token string">&quot;user.firstName = :firstName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orHaving</span><span class="token punctuation">(</span><span class="token string">&quot;user.lastName = :lastName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Saw&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">HAVING</span> <span class="token keyword">user</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span> <span class="token operator">OR</span> <span class="token keyword">user</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span>
</code></pre></div><p>你可以根据需要组合尽可能多的<code>AND</code>和<code>OR</code>表达式。
如果使用多个<code>.having</code>，后面的将覆盖所有之前的<code>HAVING</code>表达式。</p> <h2 id="添加order-by表达式"><a href="#添加order-by表达式" class="header-anchor">#</a> 添加<code>ORDER BY</code>表达式</h2> <p>添加 <code>ORDER BY</code> 很简单：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成一下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id
</code></pre></div><p>你可以将排序方向从升序更改为降序（或反之亦然）：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;DESC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ASC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也可以添加多个排序条件：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">addOrderBy</span><span class="token punctuation">(</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>还可以使用排序字段作为一个 map：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&quot;user.name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;ASC&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;user.id&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;DESC&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果你使用了多个<code>.orderBy</code>，后面的将覆盖所有之前的<code>ORDER BY</code>表达式。</p> <h2 id="添加group-by表达式"><a href="#添加group-by表达式" class="header-anchor">#</a> 添加<code>GROUP BY</code>表达式</h2> <p>添加 <code>GROUP BY</code> 表达式很简单：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id
</code></pre></div><p>如果要使用更多 group-by, 则可以使用 c<code>addGroupBy</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">addGroupBy</span><span class="token punctuation">(</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果使用了多个<code>.groupBy</code> ，则后面的将会覆盖之前所有的 <code>ORDER BY</code> 表达式。</p> <h2 id="添加limit表达式"><a href="#添加limit表达式" class="header-anchor">#</a> 添加<code>LIMIT</code>表达式</h2> <p>添加 <code>LIMIT</code> 表达式很简单：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span>
</code></pre></div><p>生成的 SQL 查询取决于数据库的类型（SQL，mySQL，Postgres 等）。
注意：如果你使用带有连接或子查询的复杂查询，LIMIT 可能无法正常工作。
如果使用分页，建议使用<code>take</code>代替。</p> <h2 id="添加offset表达式"><a href="#添加offset表达式" class="header-anchor">#</a> 添加<code>OFFSET</code>表达式</h2> <p>添加 SQL<code>OFFSET</code>表达式很简单：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span> <span class="token keyword">OFFSET</span> <span class="token number">10</span>
</code></pre></div><p>生成的 SQL 查询取决于数据库的类型（SQL，mySQL，Postgres 等）。
注意：如果你使用带有连接或子查询的复杂查询，OFFSET 可能无法正常工作。
如果使用分页，建议使用<code>skip</code>代替。</p> <h2 id="联查"><a href="#联查" class="header-anchor">#</a> 联查</h2> <p>假设有以下实体：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn<span class="token punctuation">,</span> Column<span class="token punctuation">,</span> OneToMany <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Photo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Photo&quot;</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">type</span></span> <span class="token operator">=&gt;</span> Photo<span class="token punctuation">,</span> <span class="token parameter">photo</span> <span class="token operator">=&gt;</span> photo<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
  photos<span class="token punctuation">:</span> Photo<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn<span class="token punctuation">,</span> Column<span class="token punctuation">,</span> ManyToOne <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./User&quot;</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Photo</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToOne</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">type</span></span> <span class="token operator">=&gt;</span> User<span class="token punctuation">,</span> <span class="token parameter">user</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>photos<span class="token punctuation">)</span>
  user<span class="token punctuation">:</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在让我们假设你要用用户&quot;Timber&quot;加载他所有的 photos：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">&quot;user.photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>你将会得到以下结果：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span><span class="token punctuation">,</span>
    photos<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        url<span class="token punctuation">:</span> <span class="token string">&quot;me-with-chakram.jpg&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        url<span class="token punctuation">:</span> <span class="token string">&quot;me-with-trees.jpg&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>你可以看到<code>leftJoinAndSelect</code>自动加载了所有 Timber 的 photos。
第一个参数是你要加载的关系，第二个参数是你为此关系的表分配的别名。
你可以在查询构建器中的任何位置使用此别名。
例如，让我们获得所有未删除的 Timber 的 photos。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">&quot;user.photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">&quot;photo.isRemoved = :isRemoved&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> isRemoved<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成以下 SQL 查询：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> photo<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span>
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> photos photo <span class="token keyword">ON</span> photo<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token operator">=</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id
    <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Timber'</span> <span class="token operator">AND</span> photo<span class="token punctuation">.</span>isRemoved <span class="token operator">=</span> <span class="token boolean">FALSE</span>
</code></pre></div><p>你还可以向连接表达式添加条件，而不是使用&quot;where&quot;：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">&quot;user.photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo.isRemoved = :isRemoved&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> isRemoved<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这将生成以下 sql 查询：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> photo<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span>
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> photos photo <span class="token keyword">ON</span> photo<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token operator">=</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token operator">AND</span> photo<span class="token punctuation">.</span>isRemoved <span class="token operator">=</span> <span class="token boolean">FALSE</span>
    <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Timber'</span>
</code></pre></div><h2 id="内联和左联"><a href="#内联和左联" class="header-anchor">#</a> 内联和左联</h2> <p>如果你想使用<code>INNER JOIN</code>而不是<code>LEFT JOIN</code>，只需使用<code>innerJoinAndSelect</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">innerJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">&quot;user.photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo.isRemoved = :isRemoved&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> isRemoved<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This will generate:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> photo<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span>
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> photos photo <span class="token keyword">ON</span> photo<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token operator">=</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token operator">AND</span> photo<span class="token punctuation">.</span>isRemoved <span class="token operator">=</span> <span class="token boolean">FALSE</span>
    <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Timber'</span>
</code></pre></div><p><code>LEFT JOIN</code>和<code>INNER JOIN</code>之间的区别在于，如果没有任何 photos，<code>INNER JOIN</code>将不会返回 user。
即使没有 photos，<code>LEFT JOIN</code>也会返回 user。
要了解有关不同连接类型的更多信息，请参阅 <a href="https://msdn.microsoft.com/en-us/library/zt8wzxy4.aspx" target="_blank" rel="noopener noreferrer">SQL 文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="不使用条件的联查"><a href="#不使用条件的联查" class="header-anchor">#</a> 不使用条件的联查</h2> <p>你可以在不使用条件的情况下联查数据。
要做到这一点，使用<code>leftJoin</code>或<code>innerJoin</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">innerJoin</span><span class="token punctuation">(</span><span class="token string">&quot;user.photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会生成如下 SQL 语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">user</span>
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> photos photo <span class="token keyword">ON</span> photo<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token operator">=</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id
    <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Timber'</span>
</code></pre></div><p>这将会返回 Timber 如果他有 photos，但是并不会返回他的 photos。</p> <h2 id="联查任何实体或表"><a href="#联查任何实体或表" class="header-anchor">#</a> 联查任何实体或表</h2> <p>你不仅能联查关系，还能联查任何其他实体或表。</p> <p>例如：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span>Photo<span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo.userId = user.id&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">&quot;photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo.userId = user.id&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="联查和映射功能"><a href="#联查和映射功能" class="header-anchor">#</a> 联查和映射功能</h2> <p>将<code>profilePhoto</code>添加到<code>User</code>实体，你可以使用<code>QueryBuilder</code>将任何数据映射到该属性：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token comment">/// ...</span>
  profilePhoto<span class="token punctuation">:</span> Photo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndMapOne</span><span class="token punctuation">(</span><span class="token string">&quot;user.profilePhoto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user.photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo.isForProfile = TRUE&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.name = :name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这将加载 Timber 的个人资料照片并将其设置为<code>user.profilePhoto</code>。
如果要加载并映射单个实体，请使用<code>leftJoinAndMapOne</code>。
如果要加载和映射多个实体，请使用<code>leftJoinAndMapMany</code>。</p> <h2 id="获取生成的sql查询语句"><a href="#获取生成的sql查询语句" class="header-anchor">#</a> 获取生成的sql查询语句</h2> <p>有时你可能想要获取<code>QueryBuilder</code>生成的 SQL 查询。
为此，请使用<code>getSql</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.firstName = :firstName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string">&quot;user.lastName = :lastName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Saw&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>出于调试目的，你也可以使用<code>printSql</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.firstName = :firstName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">&quot;Timber&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string">&quot;user.lastName = :lastName&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">&quot;Saw&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">printSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此查询将返回 users 并将使用的 sql 语句打印到控制台。</p> <h2 id="获得原始结果"><a href="#获得原始结果" class="header-anchor">#</a> 获得原始结果</h2> <p>使用选择查询构建器可以获得两种类型的结果：<strong>entities</strong> 和 <strong>raw results</strong>。
大多数情况下，你只需要从数据库中选择真实实体，例如 users。
为此，你可以使用<code>getOne</code>和<code>getMany</code>。
但是，有时需要选择特定数据，例如 <em>sum of all user photos</em>。
这些数据不是实体，它被称为原始数据。
要获取原始数据，请使用<code>getRawOne</code>和<code>getRawMany</code>。
例如：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;SUM(user.photosCount)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getRawOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> photosSums <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">addSelect</span><span class="token punctuation">(</span><span class="token string">&quot;SUM(user.photosCount)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sum&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getRawMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 结果将会像这样: [{ id: 1, sum: 25 }, { id: 2, sum: 13 }, ...]</span>
</code></pre></div><h2 id="流数据"><a href="#流数据" class="header-anchor">#</a> 流数据</h2> <p>你可以使用<code>stream</code>来返回流。
Streaming 返回原始数据，必须手动处理实体转换：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.id = :id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="使用分页"><a href="#使用分页" class="header-anchor">#</a> 使用分页</h2> <p>大多数情况下，在开发应用程序时，你可能需要分页功能。
如果你的应用程序中有分页，page slider 或无限滚动组件，则使用此选项。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">&quot;user.photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将会返回前 10 个 user 的 photos。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">&quot;user.photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将返回除了前 10 个 user 以外的所有 user 的 photos。</p> <p>你可以组合这些方法：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">&quot;user.photos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;photo&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这将跳过前 5 个 users，并获取他们之后的 10 个 user。</p> <p><code>take</code>和<code>skip</code>可能看起来像我们正在使用<code>limit</code>和<code>offset</code>，但它们不是。
一旦你有更复杂的连接或子查询查询，<code>limit</code>和<code>offset</code>可能无法正常工作。
使用<code>take</code>和<code>skip</code>可以防止这些问题。</p> <h2 id="加锁"><a href="#加锁" class="header-anchor">#</a> 加锁</h2> <p>QueryBuilder 支持 optimistic 和 pessimistic 锁定。
要使用 pessimistic 读锁定，请使用以下方式：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setLock</span><span class="token punctuation">(</span><span class="token string">&quot;pessimistic_read&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要使用 pessimistic 写锁定，请使用以下方式：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setLock</span><span class="token punctuation">(</span><span class="token string">&quot;pessimistic_write&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要使用 optimistic 读锁定，请使用以下方式：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setLock</span><span class="token punctuation">(</span><span class="token string">&quot;optimistic&quot;</span><span class="token punctuation">,</span> existUser<span class="token punctuation">.</span>version<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要使用 dirty 读锁定，请使用以下方式：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setLock</span><span class="token punctuation">(</span><span class="token string">&quot;dirty_read&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Optimistic 锁定与<code>@Version</code>和<code>@UpdatedDate</code>装饰器一起使用。</p> <h2 id="查询部分字段"><a href="#查询部分字段" class="header-anchor">#</a> 查询部分字段</h2> <p>如果只想选择实体的某些属性，可以使用以下语法：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user.name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这只会选择<code>User</code>的<code>id</code>和<code>name</code>。</p> <h2 id="使用子查询"><a href="#使用子查询" class="header-anchor">#</a> 使用子查询</h2> <p>你可以轻松创建子查询。 <code>FROM</code>，<code>WHERE</code>和<code>JOIN</code>表达式都支持子查询。
例如：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> qb <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRepository</span><span class="token punctuation">(</span>Post<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> posts <span class="token operator">=</span> qb
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>
    <span class="token string">&quot;post.title IN &quot;</span> <span class="token operator">+</span>
      qb
        <span class="token punctuation">.</span><span class="token function">subQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.registered = :registered&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token string">&quot;registered&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用更优雅的方式来做同样的事情：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>Post<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token parameter">qb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> subQuery <span class="token operator">=</span> qb
      <span class="token punctuation">.</span><span class="token function">subQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.registered = :registered&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;post.title IN &quot;</span> <span class="token operator">+</span> subQuery<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token string">&quot;registered&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或者，你可以创建单独的查询构建器并使用其生成的 SQL：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> userQb <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.registered = :registered&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> registered<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>Post<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;post.title IN (&quot;</span> <span class="token operator">+</span> userQb<span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setParameters</span><span class="token punctuation">(</span>userQb<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>你可以在<code>FROM</code>中创建子查询，如下所示：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> userQb <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.registered = :registered&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> registered<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> userQb<span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setParameters</span><span class="token punctuation">(</span>userQb<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getRawMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或使用更优雅的语法：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token parameter">subQuery</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> subQuery
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;user.registered = :registered&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> registered<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getRawMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果想添加一个子查询做为&quot;second from&quot;，请使用<code>addFrom</code>。</p> <p>你也可以在<code>SELECT</code>语句中使用子查询：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;post.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">addSelect</span><span class="token punctuation">(</span><span class="token parameter">subQuery</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> subQuery
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>Post<span class="token punctuation">,</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getRawMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="隐藏列"><a href="#隐藏列" class="header-anchor">#</a> 隐藏列</h2> <p>如果要查询的模型具有&quot;select：false&quot;的列，则必须使用<code>addSelect</code>函数来从列中检索信息。</p> <p>假设你有以下实体：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn<span class="token punctuation">,</span> Column <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> select<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用标准的<code>find</code>或查询，你将不会接收到模型的<code>password</code>属性。 但是，如果执行以下操作：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> connection
  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;user.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">addSelect</span><span class="token punctuation">(</span><span class="token string">&quot;user.password&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>你将在查询中获得属性<code>password</code>。</p></div> <hr> <!----></div> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#什么是querybuilder" title="什么是QueryBuilder">什么是QueryBuilder</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#如何创建和使用querybuilder" title="如何创建和使用QueryBuilder">如何创建和使用QueryBuilder</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#使用querybuilder获取值" title="使用QueryBuilder获取值">使用QueryBuilder获取值</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#什么是别名？" title="什么是别名？">什么是别名？</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#使用参数来转义数据" title="使用参数来转义数据">使用参数来转义数据</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#添加where表达式" title="添加WHERE表达式">添加WHERE表达式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#添加having表达式" title="添加HAVING表达式">添加HAVING表达式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#添加order-by表达式" title="添加ORDER BY表达式">添加ORDER BY表达式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#添加group-by表达式" title="添加GROUP BY表达式">添加GROUP BY表达式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#添加limit表达式" title="添加LIMIT表达式">添加LIMIT表达式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#添加offset表达式" title="添加OFFSET表达式">添加OFFSET表达式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#联查" title="联查">联查</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#内联和左联" title="内联和左联">内联和左联</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#不使用条件的联查" title="不使用条件的联查">不使用条件的联查</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#联查任何实体或表" title="联查任何实体或表">联查任何实体或表</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#联查和映射功能" title="联查和映射功能">联查和映射功能</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#获取生成的sql查询语句" title="获取生成的sql查询语句">获取生成的sql查询语句</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#获得原始结果" title="获得原始结果">获得原始结果</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#流数据" title="流数据">流数据</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#使用分页" title="使用分页">使用分页</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#加锁" title="加锁">加锁</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#查询部分字段" title="查询部分字段">查询部分字段</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#使用子查询" title="使用子查询">使用子查询</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#隐藏列" title="隐藏列">隐藏列</a></div></div></div></div> <footer class="footer" data-v-0d113134><div class="footer-left-wrap" data-v-0d113134><ul class="contact" data-v-0d113134><li class="contact-item" data-v-0d113134><a href="https://github.com/ulivz" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-0d113134><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-0d113134><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-0d113134></path></svg>
          
        </a></li><li class="contact-item" data-v-0d113134><a href="https://twitter.com/_ulivz" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-0d113134><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter" data-v-0d113134><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-0d113134></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-0d113134><ul class="copyright" data-v-0d113134><li class="copyright-item" data-v-0d113134><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-0d113134>Privacy Policy</a></li><li class="copyright-item" data-v-0d113134><a href="/vuepressblog/2021/04/20/select-query-builder/.html" class="nav-link" data-v-0d113134>MIT Licensed | Copyright © 2018-present Vue.js</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/vuepressblog/assets/js/app.34ed5399.js" defer></script><script src="/vuepressblog/assets/js/4.b4e60a56.js" defer></script><script src="/vuepressblog/assets/js/5.437ceeb3.js" defer></script><script src="/vuepressblog/assets/js/56.52bdbaf9.js" defer></script>
  </body>
</html>
